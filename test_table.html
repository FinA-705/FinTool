<!DOCTYPE html>
<html>
  <head>
    <title>Stock Table Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css"
    />
  </head>
  <body>
    <h1>Stock Table Test</h1>
    <table id="test-table" class="display">
      <thead>
        <tr>
          <th>代码</th>
          <th>名称</th>
          <th>价格</th>
          <th>PE</th>
          <th>PB</th>
        </tr>
      </thead>
    </table>

    <button onclick="loadData()">Load Data</button>

    <script>
      function formatNumber(num, decimals = 2) {
        if (
          num === null ||
          num === undefined ||
          typeof num !== "number" ||
          isNaN(num)
        ) {
          return "--";
        }
        return new Intl.NumberFormat("zh-CN", {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
        }).format(num);
      }

      const table = $("#test-table").DataTable({
        columns: [
          { data: "code", title: "代码" },
          { data: "name", title: "名称" },
          {
            data: "price",
            title: "价格",
            render: function (data) {
              console.log("Price render:", data, typeof data);
              return formatNumber(data);
            },
          },
          {
            data: "pe",
            title: "PE",
            render: function (data) {
              console.log("PE render:", data, typeof data);
              return formatNumber(data, 1);
            },
          },
          {
            data: "pb",
            title: "PB",
            render: function (data) {
              console.log("PB render:", data, typeof data);
              return formatNumber(data, 1);
            },
          },
        ],
      });

      function loadData() {
        fetch("/api/v1/stocks/data?limit=3")
          .then((response) => response.json())
          .then((data) => {
            console.log("API response:", data);
            if (data.success && data.data) {
              console.log("Loading data into table:", data.data);
              table.clear().rows.add(data.data).draw();
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      // Auto load data
      loadData();
    </script>
  </body>
</html>
